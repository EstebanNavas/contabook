<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
 	<head th:replace ="combo/head.html :: head" ></head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" th:href="@{/styles/login.css}">
        <link rel="stylesheet" type="text/css" th:href="@{/styles/General.css}"> 
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/fuenteColor.css}">  	
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/NavBar.css}"> 
    	<link rel="stylesheet" type="text/css" th:href="@{/styles/ComprobanteContable.css}">
    	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <title> Contabook</title>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>
	<header th:replace="combo/navBar.html :: navbar"></header>
	<div class="containerFlex" id="encabezado">
		<div class="local">
			<h2 class="letraBlue" th:replace="combo/comboLocal.html :: comboLocal"></h2>
		</div>
		<div class="descripcion">
			<h2 class="tituloAFcenter">NUEVO DOCUMENTO CONTABLE</h2>
			<h3 th:replace="combo/comboPeriodo.html :: comboPeriodo"></h3>
		</div>
		<div class="fechahora">
			<h2 class="letra" th:replace="combo/FechaHoraActual.html :: comboFechaHora"></h2>
		</div>
	</div>
	
	<div class="tipoComprobante">
		<div>
			<label>Tipo de Comprobante</label>			
		</div>
		<div style="margin-left: 60px; ">
			<select  id="tipoComprobante" style="width: 400px; height: 25px;">
        	 <option th:text="${xLista.getIdTipoCpte() + ' - ' + xLista.getNombreCmpte()}" th:each="xLista:${xListaComprobantes}" th:value="${xLista.getIdTipoCpte()}" ></option>
			</select>
		</div>		

	</div>
	
    <div class="fechaComprobante">
		<div>
			<label>Fecha de elaboraci√≥n</label>			
		</div>
		<div style="margin-left: 60px; ">
			<input class="select-barra-verde" type="date" id="fechaComprobante" style="margin-left: 6px; height: 25px;" th:value="${xFechaActual}"  pattern="\d{4}-\d{2}-\d{2}T\d{2}:\d{2}" required>
		</div>			
	</div>
	
	
	<div class="tablaContable">
		 <table id="tabla">
        <thead>
            <tr>
                <th>#</th>
                <th>Cuenta contable</th>
                <th>Tercero</th>
                <th>Detalle contable</th>
                <th>Descripci√≥n</th>
                <th>D√©bito</th>
                <th>Cr√©dito</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td>
                    <div class="search-container">
                            <input type="text" placeholder="Buscar" id="buscarCuenta" onfocus="BuscarCuentas(1)">
                            <span class="icon">üîç</span>
                            <div class="results-container" id="results" style="height: 200px;"></div>
                      </div>
                </td>
                <td>
                    <div class="search-container">
                        <input type="text" placeholder="Buscar" id="buscarTercero" onfocus="BuscarTerceros(1)">
                        <span class="icon">üîç</span>
                        <div class="results-container" id="terceros" style="height: 200px;" ></div>
                    </div>
                </td>
                <td>
					<input type="text" id="detalleContable">
                </td>
                <td>
					<input type="text" style="width: 350px;" id="descripcion">
				</td>
                <td>
					<input type="text" value="0.00" style="width: 80px;" id="debito">
				</td>
                <td>
					<input type="text" value="0.00" style="width: 80px;" id="credito">
				</td>
				<td>
                  <div class="credito-container">
                   <span class="icon save-icon" style="margin-left: 8px;" onclick="agregarFila()">
					   <i class="fas fa-save" ></i>
				   </span>
                   <span class="icon delete-icon" style="margin-left: 8px;">
					   <i class="fas fa-trash-alt"></i>
				   </span>
                 </div>
               </td>
            </tr>
        </tbody>
    </table>
    
    <div class="totals-row">
        <div class="empty-space"></div>
        <div class="totales">
		   <div class="total-debito">
			<strong>Total:</strong> 
		  </div>
		  <div class="total-debito">
			<span id="totalDebitoResumen">0.00</span>
		  </div>
		  <div class="total-debito">
			<span id="totalCreditoResumen">0.00</span>
		  </div>
		  <div class="total-debito">
			<span id="totalCreditoResumen"></span>
		  </div>
			
		</div>

    </div>
    <div class="totals-row">
        <div class="empty-space"></div>
        <div class="totales">
		   <div class="total-debito">
			<strong>Diferencia:</strong> 
		  </div>
		  <div class="total-debito">
			<span ></span>
		  </div>
		  <div class="total-debito">
			<span id="diferencia">0.00</span>
		  </div>
		  <div class="total-debito">
			<span ></span>
		  </div>
			
		</div>
    </div>
		
	</div>
	
	
	<div class="divCencer" style="margin-top: 100px;">				
    	<a href="./menuPrincipal" class="btn btn-primary" style="margin: 25px;">Regresar</a>
		<button type="button" class="btn btn-success" value="Guardar" style="width: 100px;" onclick="GuardarDctoContable()" >Guardar</button>
	</div>



	<script type="text/javascript" th:inline="javascript">

let listaCuentas = []; // Almacena todas las cuentas 
let listaTerceros = [];

function agregarFila() {
    let tabla = document.querySelector(".tablaContable tbody");
    let nuevaFila = document.createElement("tr");
    
    // Contamos cu√°ntas filas hay en la tabla (para asignar el n√∫mero correcto)
    let numFila = tabla.rows.length + 1;

    nuevaFila.innerHTML = `
        <td>${numFila}</td>
        <td>
            <div class="search-container">
                <input type="text" placeholder="Buscar" id="buscarCuenta${numFila}" onfocus="BuscarCuentas(${numFila})">
                <span class="icon">üîç</span>
                <div class="results-container" id="results${numFila}" style="height: 200px;"></div>
            </div>
        </td>
        <td>
            <div class="search-container">
                <input type="text" placeholder="Buscar" id="buscarTercero${numFila}" onfocus="BuscarTerceros(${numFila})">
                <span class="icon">üîç</span>
                <div class="results-container" id="terceros${numFila}" style="height: 200px;"></div>
            </div>
        </td>
        <td><input type="text"></td>
        <td><input type="text" style="width: 350px;" id="descripcion${numFila}"></td>
        <td><input type="text" value="0.00" style="width: 80px;" id="debito${numFila}"></td>
        <td><input type="text" value="0.00" style="width: 80px;" id="credito${numFila}"></td>
        <td>
            <div class="credito-container">
                <span class="icon save-icon" style="margin-left: 8px;" onclick="agregarFila()">
                    <i class="fas fa-save"></i>
                </span>
                <span class="icon delete-icon" style="margin-left: 8px;" onclick="eliminarFila(this)">
                    <i class="fas fa-trash-alt"></i>
                </span>
            </div>
        </td>
    `;

    tabla.appendChild(nuevaFila);
    
    // A√±adir el event listener para los nuevos inputs de b√∫squeda de cuenta
    const inputCuentaNuevo = nuevaFila.querySelector(`#buscarCuenta${numFila}`);
    inputCuentaNuevo.addEventListener("input", function() {
        let fila = this.closest('tr').rowIndex; // Obt√©n el n√∫mero de fila din√°micamente
        let filtro = this.value.toLowerCase();
        let cuentasFiltradas = listaCuentas.filter(cuenta =>
            `${cuenta.idCuentaAux} - ${cuenta.nombreCuenta}`.toLowerCase().includes(filtro)
        );
        mostrarCuentas(cuentasFiltradas, fila); // Pasa el n√∫mero de fila
    });
    
    
       // A√±adir el event listener para los nuevos inputs de b√∫squeda de terceros
    const inputTerceroNuevo = nuevaFila.querySelector(`#buscarTercero${numFila}`);
    inputTerceroNuevo.addEventListener("input", function() {
        let fila = this.closest('tr').rowIndex; // Obt√©n el n√∫mero de fila din√°micamente
        let filtro = this.value.toLowerCase();
        let tercerosFiltrados = listaTerceros.filter(tercero =>
            `${tercero.cc_Nit} - ${tercero.nombreTercero}`.toLowerCase().includes(filtro)
        );
        mostrarTerceros(tercerosFiltrados, fila); // Pasa el n√∫mero de fila
    });
    
    
    // Ejecutar la funci√≥n al cargar la p√°gina
    calcularTotales();
}

// Actualizaci√≥n de las funciones para recibir un par√°metro din√°mico (n√∫mero de fila)
function BuscarCuentas(fila) {
    console.log(`Ingres√≥ a BuscarCuentas en fila ${fila}`);

    fetch("./ObtenerCuentas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        listaCuentas = data.xlistaCuentas; 
        mostrarCuentas(listaCuentas, fila); // Pasamos la fila para saber d√≥nde actualizar
    })
    .catch(error => console.error("Error al obtener cuentas:", error));
}

function mostrarCuentas(cuentas, fila) {
    console.log(`Fila en mostrarCuentas es ${fila}`);

    // Si es la primera fila, usa los IDs sin n√∫mero
    let resultsContainer = fila === 1 ? document.getElementById("results") : document.getElementById(`results${fila}`);
    let inputCuenta = fila === 1 ? document.getElementById("buscarCuenta") : document.getElementById(`buscarCuenta${fila}`);
    let inputDescripcion = fila === 1 ? document.getElementById("descripcion") : document.getElementById(`descripcion${fila}`);

    resultsContainer.innerHTML = "";

    if (cuentas.length === 0) {
        resultsContainer.style.display = "none";
        return;
    }

    cuentas.forEach(cuenta => {
        let item = document.createElement("div");
        item.classList.add("result-item");
        item.textContent = `${cuenta.idCuentaAux} - ${cuenta.nombreCuenta}`;
        item.onclick = () => {
            inputCuenta.value = `${cuenta.idCuentaAux} - ${cuenta.nombreCuenta}`;
            inputCuenta.setAttribute("data-idCuenta", cuenta.idCuentaAux);
            inputDescripcion.value = `${cuenta.idCuentaAux} - ${cuenta.nombreCuenta}`;
            
            resultsContainer.style.display = "none";
        };
        resultsContainer.appendChild(item);
    });

    resultsContainer.style.display = "block";
}

// Misma l√≥gica aplicada a `BuscarTerceros`
function BuscarTerceros(fila) {
    console.log(`Ingres√≥ a BuscarTerceros en fila ${fila}`);

    fetch("./ObtenerTerceros", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        listaTerceros = data.xListaTerceros; 
        mostrarTerceros(listaTerceros, fila);
    })
    .catch(error => console.error("Error al obtener terceros:", error));
}

function mostrarTerceros(terceros, fila) {
	console.log(`Fila en mostrarTerceros es ${fila}`);
  //  let resultsContainer = document.getElementById(`terceros${fila}`);
    
    
    // Si es la primera fila, usa los IDs sin n√∫mero
    let resultsContainer = fila === 1 ? document.getElementById("terceros") : document.getElementById(`terceros${fila}`);
    let inputTercero = fila === 1 ? document.getElementById("buscarTercero") : document.getElementById(`buscarTercero${fila}`);

    resultsContainer.innerHTML = "";
    
    if (terceros.length === 0) {
        resultsContainer.style.display = "none";
        return;
    }

    terceros.forEach(tercero => {
        let item = document.createElement("div");
        item.classList.add("result-item");
        item.textContent = `${tercero.cc_Nit} - ${tercero.nombreTercero}`;
        item.onclick = () => {
            inputTercero.value = `${tercero.cc_Nit} - ${tercero.nombreTercero}`;
            inputTercero.setAttribute("data-idTercero", tercero.cc_Nit);
            console.log("CC_NIT esssss" + tercero.cc_Nit );
            
            resultsContainer.style.display = "none";
        };
        resultsContainer.appendChild(item);
    });

    resultsContainer.style.display = "block";
}

// Funci√≥n para eliminar filas din√°micamente
function eliminarFila(elemento) {
    let fila = elemento.closest("tr");
    fila.remove();

    // Recalcular los n√∫meros de fila despu√©s de eliminar
    let filas = document.querySelectorAll(".tablaContable tbody tr");
    filas.forEach((fila, index) => {
        fila.children[0].textContent = index + 1;
    });
}


//----------------------------------------------------------------------------------

// Filtrar en tiempo real
document.querySelectorAll("#buscarCuenta, .buscarCuenta").forEach(input => {
    input.addEventListener("input", function() {
        let fila = this.closest('tr').rowIndex; // Obt√©n el √≠ndice de la fila
        console.log("la fila es:  " + fila)
        let filtro = this.value.toLowerCase();
        let cuentasFiltradas = listaCuentas.filter(cuenta =>
            `${cuenta.idCuentaAux} - ${cuenta.nombreCuenta}`.toLowerCase().includes(filtro)
        );
        mostrarCuentas(cuentasFiltradas, fila); // Pasamos el n√∫mero de fila din√°micamente
    });
});


document.querySelectorAll("#buscarTercero, .buscarTercero").forEach(input => {
    input.addEventListener("input", function() {
        let fila = this.closest('tr').rowIndex; // Obt√©n el √≠ndice de la fila
        console.log("la fila es:  " + fila)
        let filtro = this.value.toLowerCase();
        let tercerosFiltrados = listaTerceros.filter(tercero =>
            `${tercero.cc_Nit} - ${tercero.nombreTercero}`.toLowerCase().includes(filtro)
        );
        mostrarTerceros(tercerosFiltrados, fila); // Pasamos el n√∫mero de fila din√°micamente
    });
});



// Cerrar el dropdown si se hace clic fuera
document.addEventListener("click", function(event) {
    let inputCuenta = document.getElementById("buscarCuenta");
    let resultsContainer = document.getElementById("results");
    
    let inputTercero = document.getElementById("buscarTercero");
    let tercerosContainer = document.getElementById("terceros");

    if (!inputCuenta.contains(event.target) && !resultsContainer.contains(event.target)) {
        resultsContainer.style.display = "none";
        listaCuentas = []; // Vaciar la lista para evitar que siga abierta
    }
    
        if (!inputTercero.contains(event.target) && !tercerosContainer.contains(event.target)) {
        tercerosContainer.style.display = "none";
        listaTerceros = []; // Vaciar la lista para evitar que siga abierta
    }
});

//--------------------------------------------------------------------------------------------------------------

function calcularTotales() {
    console.log("Ingres√≥ al calcularTotales");
    let totalDebito = 0, totalCredito = 0;

    // Sumar valores de la columna D√©bito
    document.querySelectorAll("[id^='debito']").forEach(input => {
        totalDebito += parseFloat(input.value) || 0;
    });

    // Sumar valores de la columna Cr√©dito
    document.querySelectorAll("[id^='credito']").forEach(input => {
        totalCredito += parseFloat(input.value) || 0;
    });

    console.log("totalDebito " + totalDebito);
    console.log("totalCredito " + totalCredito);

    // Actualizar los valores en la fila de totales
    document.getElementById("totalDebitoResumen").textContent = totalDebito.toFixed(2);
    document.getElementById("totalCreditoResumen").textContent = totalCredito.toFixed(2);

    // Calcular la diferencia
    let diferencia = totalDebito - totalCredito;
    document.getElementById("diferencia").textContent = diferencia.toFixed(2);

    // Cambiar color seg√∫n la diferencia
    let diferenciaElement = document.getElementById("diferencia");
    diferenciaElement.style.color = diferencia === 0 ? "green" : "red";
}



function GuardarDctoContable() {
    
    calcularTotales();
    
    var xCuentaArr = [];
    var xTerceroArr = [];
    var xDetalleContableArr = [];
    var xDescripcionArr = [];
    var xDebitoArr = [];
    var xCreditoArr = [];
    
    var tipoComprobante = document.getElementById("tipoComprobante").value;
    var fechaComprobante = document.getElementById("fechaComprobante").value;

    // Obtener totalD√©bito y totalCr√©dito
    let totalDebito = parseFloat(document.getElementById("totalDebitoResumen").textContent) || 0;
    let totalCredito = parseFloat(document.getElementById("totalCreditoResumen").textContent) || 0;

    // Verificar si hay diferencia
    if (totalDebito !== totalCredito) {
        swal({
            title: "Error",
            text: "El total del D√©bito y el total del Cr√©dito no coinciden.",
            icon: "error",
            button: "Aceptar",
        });
        return;
    }

    var tabla = document.querySelector("#tabla tbody");

    // Filas de la tabla
    var filas = tabla.querySelectorAll("tr");

    // Bandera filas vac√≠as
    var filasVacias = false;

    // Iterar sobre cada fila de la tabla
    filas.forEach(function(fila) {
        var elementos = fila.querySelectorAll("td");

        var cuenta = elementos[1].querySelector("input").getAttribute("data-idCuenta") || "";       
        var tercero = elementos[2].querySelector("input").getAttribute("data-idTercero") || "";
        var detalleContable = elementos[3].querySelector("input").value.trim();
        var descripcion = elementos[4].querySelector("input").value.trim();
        var debito = elementos[5].querySelector("input").value.trim();
        var credito = elementos[6].querySelector("input").value.trim();

        console.log("cuenta: " + cuenta);
        console.log("tercero: " + tercero);
        console.log("detalleContable: " + detalleContable);
        console.log("descripcion: " + descripcion);
        console.log("debito: " + debito);
        console.log("credito: " + credito);

        // Verificar si hay una fila vac√≠a
        if (!cuenta || !tercero || !detalleContable || !descripcion || (!debito && !credito)) {
            filasVacias = true;
        }

        xCuentaArr.push(cuenta);
        xTerceroArr.push(tercero);
        xDetalleContableArr.push(detalleContable);
        xDescripcionArr.push(descripcion);    
        xDebitoArr.push(debito); 
        xCreditoArr.push(credito); 
    });

    
    if (filasVacias) {
        swal({
            title: "Error",
            text: "Hay filas incompletas. Por favor, llena todos los campos antes de guardar.",
            icon: "error",
            button: "Aceptar",
        });
        return;
    }

    // Crear un objeto con los datos a enviar
    var datos = {
        xCuentaArr: xCuentaArr,
        xTerceroArr: xTerceroArr,
        xDetalleContableArr: xDetalleContableArr,
        xDescripcionArr: xDescripcionArr,
        xDebitoArr: xDebitoArr,
        xCreditoArr: xCreditoArr,
        tipoComprobante: tipoComprobante,
        fechaComprobante: fechaComprobante
    };

    // Realizar la solicitud POST solo si todas las filas tienen datos
    fetch("./GuardarDctoContable-Post", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(datos),
    })
    .then((response) => response.json())
    .then((data) => {
		
		var numComprobante = data.xComprobante;
		
        swal({
            title: "¬°Documento contable " + numComprobante + " guardado correctamente!",
            icon: "success",
            button: "Continuar",
        }).then((value) => {
            if (value) {
                window.location.href = "./ComprobanteContable";
            }
        });
    })
    .catch((error) => {
        console.error("Error al registrar el log:", error);
    });
}
		
	</script>
</body>

</html>